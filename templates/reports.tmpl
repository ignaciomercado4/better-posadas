<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reports Map - Posadas, Misiones</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
</head>
<body class="font-sans max-w-screen-xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold mb-4">{{.title}}</h1>
    
    <div class="bg-gray-100 p-5 rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-semibold mb-4">Create New Report</h2>
        <form id="newReportForm" class="space-y-4">
            <input 
                type="text" 
                name="title" 
                placeholder="Report Title" 
                required 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            
            <select 
                name="category" 
                required 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
                <option value="">Select Category</option>
                <option value="Infrastructure">Infrastructure</option>
                <option value="Environment">Environment</option>
                <option value="Public Safety">Public Safety</option>
                <option value="Transportation">Transportation</option>
                <option value="Other">Other</option>
            </select>
            
            <textarea 
                name="description" 
                placeholder="Detailed Description" 
                required 
                rows="4" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            ></textarea>
            
            <div class="bg-gray-200 p-3 rounded-md mb-4">
                <strong class="block mb-2">Coordinates:</strong> 
                <span id="coordinateDisplay" class="text-sm">Not set</span>
            </div>
            
            <input type="hidden" id="positionX" name="positionX" required>
            <input type="hidden" id="positionY" name="positionY" required>
            
            <p class="text-sm text-gray-600 mb-4"><strong>Click on the map to set location</strong></p>
            
            <button 
                type="submit" 
                class="w-full bg-green-500 text-white py-2 rounded-md hover:bg-green-600 transition duration-300 ease-in-out"
            >
                Submit Report
            </button>
        </form>
    </div>

    <div 
        id="map" 
        class="h-[500px] w-full bg-gray-100 rounded-lg shadow-md mb-6"
    ></div>


    <script>
        const posadas = [-27.3621, -55.9045];
        
        const map = L.map('map').setView(posadas, 12);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let newReportMarker = null;
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            if (newReportMarker) {
                map.removeLayer(newReportMarker);
            }

            newReportMarker = L.marker([lat, lng]).addTo(map)
                .bindPopup('New Report Location').openPopup();

            document.getElementById('positionX').value = lat.toFixed(6);
            document.getElementById('positionY').value = lng.toFixed(6);
            
            document.getElementById('coordinateDisplay').textContent = 
                `Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(6)}`;
        });

        document.getElementById('newReportForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const posX = document.getElementById('positionX').value;
            const posY = document.getElementById('positionY').value;

            if (!posX || !posY) {
                alert('Please click on the map to set the report location');
                return;
            }

            const formData = {
                title: event.target.title.value,
                category: event.target.category.value,
                description: event.target.description.value,
                positionX: parseFloat(posX),
                positionY: parseFloat(posY)
            };

            fetch('/reports/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                alert('Report created successfully!');
                location.reload();
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Failed to create report');
            });
        });
    </script>
    <script>
        const categoryColors = {
            'Infrastructure': 'bg-red-500',
            'Environment': 'bg-green-500',
            'Public Safety': 'bg-blue-500',
            'Transportation': 'bg-purple-500',
            'Other': 'bg-yellow-500'
        };
    
        function createMarkerIcon(category) {
            const color = categoryColors[category] || 'bg-gray-500';
            
            return L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div class="relative w-8 h-8 ${color} rounded-full border-2 border-white shadow-md">
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full"></div>
                    </div>
                `,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
        }
    
        {{if .reports}}
            {{range .reports}}
            L.marker(
                [{{.PositionX}}, {{.PositionY}}], 
                {icon: createMarkerIcon('{{.Category}}')}
            )
            .addTo(map)
            .bindPopup(`
                <b>{{.Title}}</b><br>
                Category: {{.Category}}<br>
                Description: {{.Description}}
            `);
            {{end}}
        {{end}}
    </script>
</body>
</html>